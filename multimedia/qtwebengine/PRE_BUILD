default_pre_build &&

# Current python has removed this
sedit 's:import imp::' src/3rdparty/chromium/mojo/public/tools/mojom/mojom/fileutil.py &&
sedit 's:import imp::' src/3rdparty/chromium/mojo/public/tools/mojom/mojom/parse/lexer.py &&

# Current re2 version causes build failure, use internal
sedit 's:use_system_re2=true:use_system_re2=false:' src/core/config/linux.pri &&

sed -i -e 's|use_jumbo_build=true|use_jumbo_build=false|' src/buildtools/config/common.pri &&

sed -e '/link_pulseaudio/s/false/true/' -i src/3rdparty/chromium/media/media_options.gni &&

find -type f -name "*.pr[io]" | xargs sed -i -e 's|INCLUDEPATH += |&$$QTWEBENGINE_ROOT/include |' &&

# So it doesn't link to the old version.
if [ -e /usr/lib/qt5/libQt5WebEngineCore.so ]; then
  mv -v /usr/lib/qt5/libQt5WebEngineCore.so{,.old}
fi &&


patch -p1 -d src/3rdparty -i $SCRIPT_DIRECTORY/qt5-webengine-ffmpeg5.patch &&
patch -p1 -d src/3rdparty -i $SCRIPT_DIRECTORY/qt5-webengine-pipewire-0.3.patch &&
patch -p2 -d src/3rdparty/chromium -i $SCRIPT_DIRECTORY/qt5-webengine-icu-75.patch &&
patch -p1 -d src/3rdparty/chromium -i $SCRIPT_DIRECTORY/python3.12-six.patch &&
patch -p2 -d src/3rdparty/chromium -i $SCRIPT_DIRECTORY/qt5-webengine-ninja-1.12.patch &&
patch -p1 -d src/3rdparty/chromium -i $SCRIPT_DIRECTORY/qt5-webengine-ffmpeg7.patch &&

#Quoting the LFS folks here;
#Although the patches used in this module ensures git is not invoked during the build, the build system has
#labyrinthine rules of byzantine complexity, and in particular trying to build without two .git directories
#will lead to it eventually falling into unexpected and unbuildable code which references a private header
#that has not been created. Avoid this by creating the required directories
mkdir -pv .git src/3rdparty/chromium/.git
